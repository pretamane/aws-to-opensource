# Prometheus Configuration
# Replaces AWS CloudWatch for metrics collection

global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    environment: "production"
    project: "realistic-demo-pretamane"

# Alerting configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets: ["alertmanager:9093"]
          labels:
            service: "alertmanager"

# Rule files for alerting and SLOs
rule_files:
  - "/etc/prometheus/alert-rules.yml"
  - "/etc/prometheus/slo-rules.yml"

# Scrape configurations
scrape_configs:
  # Prometheus self-monitoring
  - job_name: "prometheus"
    static_configs:
      - targets: ["localhost:9090"]
        labels:
          service: "prometheus"
          component: "monitoring"

  # FastAPI application metrics (internal port for security)
  - job_name: "fastapi-app"
    static_configs:
      - targets: ["fastapi-app:9091"]
        labels:
          service: "fastapi-app"
          component: "application"
    scrape_interval: 10s
    metrics_path: "/metrics"
    # Note: Metrics exposed on internal port 9091, not public port 8000

  # PostgreSQL metrics (via postgres_exporter)
  # COMMENTED: postgres_exporter not installed yet (Phase 5)
  # - job_name: "postgresql"
  #   static_configs:
  #     - targets: ["postgresql:5432"]
  #       labels:
  #         service: "postgresql"
  #         component: "database"

  # Meilisearch metrics
  # COMMENTED: /metrics endpoint not confirmed (Phase 1)
  # - job_name: "meilisearch"
  #   static_configs:
  #     - targets: ["meilisearch:7700"]
  #       labels:
  #         service: "meilisearch"
  #         component: "search"
  #   metrics_path: "/metrics"

  # MinIO metrics
  - job_name: "minio"
    static_configs:
      - targets: ["minio:9000"]
        labels:
          service: "minio"
          component: "storage"
    metrics_path: "/minio/v2/metrics/cluster"

  # Grafana metrics
  - job_name: "grafana"
    static_configs:
      - targets: ["grafana:3000"]
        labels:
          service: "grafana"
          component: "monitoring"
    metrics_path: "/metrics"

  # Loki metrics
  - job_name: "loki"
    static_configs:
      - targets: ["loki:3100"]
        labels:
          service: "loki"
          component: "logging"
    metrics_path: "/metrics"

  # Caddy metrics (if enabled)
  # COMMENTED: Requires admin API plugin (Phase 1)
  # - job_name: "caddy"
  #   static_configs:
  #     - targets: ["caddy:2019"]
  #       labels:
  #         service: "caddy"
  #         component: "proxy"
  #   metrics_path: "/metrics"

  # Node exporter for host system metrics
  - job_name: "node-exporter"
    static_configs:
      - targets: ["node-exporter:9100"]
        labels:
          service: "node-exporter"
          component: "system-monitoring"
    scrape_interval: 15s

  # cAdvisor for container metrics
  - job_name: "cadvisor"
    static_configs:
      - targets: ["cadvisor:8080"]
        labels:
          service: "cadvisor"
          component: "container-monitoring"
    scrape_interval: 15s

  # Blackbox exporter for synthetic monitoring
  - job_name: "blackbox-exporter"
    static_configs:
      - targets: ["blackbox-exporter:9115"]
        labels:
          service: "blackbox-exporter"
          component: "synthetic-monitoring"
    metrics_path: "/metrics"
    scrape_interval: 30s
    params:
      module: ["http_2xx"] # Default module, will be overridden by relabeling

  # ============================================================================
  # BLACKBOX PROBES - Synthetic Monitoring of Endpoints
  # ============================================================================

  # HTTP probes for public endpoints (via Cloudflare Tunnel)
  - job_name: "blackbox-http-public"
    metrics_path: "/probe"
    params:
      module: ["http_2xx"]
    static_configs:
      - targets:
          # Main application endpoint
          - "http://caddy:80/"
          - "http://caddy:80/health"
          # API endpoints
          - "http://caddy:80/api/health"
          - "http://caddy:80/api/docs"
          # Monitoring UIs
          - "http://caddy:80/grafana/api/health"
          - "http://caddy:80/prometheus/-/healthy"
          # Add your Cloudflare Tunnel URL here:
          # - "https://your-tunnel-name.your-domain.com"
          # - "https://your-tunnel-name.your-domain.com/api/health"
        labels:
          probe_type: "http"
          endpoint_type: "public"
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: "blackbox-exporter:9115"

  # HTTP probes for internal services
  - job_name: "blackbox-http-internal"
    metrics_path: "/probe"
    params:
      module: ["http_2xx"]
    static_configs:
      - targets:
          # Application services
          - "http://fastapi-app:8000/health"
          - "http://meilisearch:7700/health"
          - "http://minio:9000/minio/health/live"
          # Monitoring stack
          - "http://prometheus:9090/-/healthy"
          - "http://grafana:3000/api/health"
          - "http://loki:3100/ready"
          - "http://alertmanager:9093/-/healthy"
        labels:
          probe_type: "http"
          endpoint_type: "internal"
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: "blackbox-exporter:9115"

  # HTTP probes for admin endpoints (should return 401 without auth)
  - job_name: "blackbox-http-admin"
    metrics_path: "/probe"
    params:
      module: ["http_basic_auth_401"]
    static_configs:
      - targets:
          - "http://caddy:80/pgadmin"
          - "http://caddy:80/grafana"
          - "http://minio:9001" # MinIO console
        labels:
          probe_type: "http"
          endpoint_type: "admin"
          expected_status: "401"
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: "blackbox-exporter:9115"

  # HTTPS probes with SSL certificate validation (for production Cloudflare Tunnel)
  - job_name: "blackbox-https-tunnel"
    metrics_path: "/probe"
    params:
      module: ["http_latency"]
    static_configs:
      - targets:
          # Add your production Cloudflare Tunnel URLs here:
          # - "https://your-tunnel-name.your-domain.com"
          # - "https://your-tunnel-name.your-domain.com/api/health"
          # - "https://your-tunnel-name.your-domain.com/grafana"
        labels:
          probe_type: "https"
          endpoint_type: "tunnel"
          ssl_check: "enabled"
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: "blackbox-exporter:9115"

  # TCP probes for port connectivity
  - job_name: "blackbox-tcp"
    metrics_path: "/probe"
    params:
      module: ["tcp_connect"]
    static_configs:
      - targets:
          - "postgresql:5432"
          - "meilisearch:7700"
          - "minio:9000"
          - "prometheus:9090"
          - "grafana:3000"
          - "loki:3100"
        labels:
          probe_type: "tcp"
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: "blackbox-exporter:9115"
# ============================================================================
# CONFIGURATION NOTES:
# ============================================================================
#
# 1. CLOUDFLARE TUNNEL MONITORING:
#    - Replace placeholder URLs with your actual Cloudflare Tunnel domain
#    - Example: https://pretamane.yourdomain.com
#    - Monitor both the main site and critical API endpoints
#
# 2. BLACKBOX PROBE TYPES:
#    - http_2xx: Checks for successful HTTP 200 responses
#    - http_basic_auth_401: Verifies auth is required (returns 401)
#    - http_latency: Measures response time with SSL validation
#    - tcp_connect: Tests TCP port connectivity
#
# 3. ALERTING:
#    - Alerts are configured in alert-rules.yml
#    - Check for probe_success == 0 (endpoint down)
#    - Monitor probe_duration_seconds for latency
#
# 4. GRAFANA DASHBOARDS:
#    - Query: probe_success{job="blackbox-http-public"}
#    - Query: probe_duration_seconds{job="blackbox-http-public"}
#    - Query: probe_http_status_code
#
# 5. TESTING:
#    - Check targets: http://localhost:9090/targets
#    - Manual probe: curl http://localhost:9115/probe?target=http://caddy:80&module=http_2xx
