# Alertmanager Configuration
# Handles alerts from Prometheus and routes them to appropriate receivers

global:
  resolve_timeout: 5m

  # AWS SES SMTP Configuration (recommended for production)
  # Using AWS SES SMTP interface (not API) for standard SMTP compatibility
  # Region endpoints: https://docs.aws.amazon.com/ses/latest/dg/smtp-connect.html
  # smtp_smarthost: 'email-smtp.ap-southeast-1.amazonaws.com:587'  # TLS
  # smtp_from: '${SES_FROM_EMAIL}'
  # smtp_auth_username: '${AWS_SES_SMTP_USERNAME}'  # Not the same as IAM access key!
  # smtp_auth_password: '${AWS_SES_SMTP_PASSWORD}'  # SMTP password from SES console
  # smtp_require_tls: true

# Templates for alert notifications
templates:
  - "/etc/alertmanager/*.tmpl"

# Route tree for alert distribution
route:
  # Default receiver for all alerts
  receiver: "default-receiver"

  # Group alerts by these labels
  group_by: ["alertname", "cluster", "service"]

  # Wait time before sending initial notification
  group_wait: 10s

  # Wait time before sending notification about new alerts in the same group
  group_interval: 10s

  # Wait time before re-sending a notification
  repeat_interval: 12h

  # Child routes for specific alert types
  routes:
    # Critical alerts - immediate notification to all channels
    - match:
        severity: critical
      receiver: "critical-receiver"
      group_wait: 0s
      repeat_interval: 5m
      continue: true # Also send to default receiver

    # Warning alerts - less urgent
    - match:
        severity: warning
      receiver: "warning-receiver"
      repeat_interval: 30m

    # Security alerts - special handling
    - match:
        category: security
      receiver: "security-receiver"
      group_wait: 5s
      repeat_interval: 15m

    # Infrastructure alerts
    - match:
        category: infrastructure
      receiver: "infrastructure-receiver"
      group_by: ["alertname", "instance"]

    # Database alerts
    - match:
        category: database
      receiver: "database-receiver"
      group_wait: 30s

# Inhibition rules - suppress certain alerts when others are firing
inhibit_rules:
  # Suppress warning if critical alert is firing for same instance
  - source_match:
      severity: "critical"
    target_match:
      severity: "warning"
    equal: ["alertname", "instance"]

  # Suppress infrastructure warnings when service is down
  - source_match:
      alertname: "ServiceDown"
    target_match:
      category: "infrastructure"
    equal: ["instance"]

# Receivers define how to notify about alerts
receivers:
  # ============================================================================
  # DEFAULT RECEIVER - Fallback for uncategorized alerts
  # ============================================================================
  - name: "default-receiver"
    # Webhook for custom integrations (e.g., logging, ticketing systems)
    # webhook_configs:
    #   - url: 'http://webhook-service:5001/alerts'
    #     send_resolved: true
    #     http_config:
    #       bearer_token: 'your-webhook-secret-token'

  # ============================================================================
  # CRITICAL ALERTS - Multiple notification channels
  # ============================================================================
  - name: "critical-receiver"

    # === SLACK CONFIGURATION ===
    # Create incoming webhook: https://api.slack.com/messaging/webhooks
    # slack_configs:
    #   - api_url: 'https://hooks.slack.com/services/T00000000/B00000000/XXXXXXXXXXXXXXXXXXXX'
    #     channel: '#critical-alerts'
    #     username: 'AlertManager'
    #     icon_emoji: ':rotating_light:'
    #     title: 'CRITICAL ALERT: {{ .GroupLabels.alertname }}'
    #     text: '{{ range .Alerts }}*Alert:* {{ .Annotations.summary }}\n*Details:* {{ .Annotations.description }}\n*Severity:* {{ .Labels.severity }}\n*Time:* {{ .StartsAt.Format "2006-01-02 15:04:05" }}\n{{ end }}'
    #     send_resolved: true
    #     color: '{{ if eq .Status "firing" }}danger{{ else }}good{{ end }}'

    # === DISCORD CONFIGURATION ===
    # Create webhook in Discord: Server Settings > Integrations > Webhooks
    # Note: Discord uses Slack-compatible webhook format with /slack suffix
    # webhook_configs:
    #   - url: 'https://discord.com/api/webhooks/YOUR_WEBHOOK_ID/YOUR_WEBHOOK_TOKEN/slack'
    #     send_resolved: true
    #     http_config:
    #       follow_redirects: true

    # === AWS SES EMAIL CONFIGURATION ===
    # Requires global SMTP settings configured above
    # email_configs:
    #   - to: '${SES_TO_EMAIL}'
    #     from: '${SES_FROM_EMAIL}'
    #     headers:
    #       Subject: '[CRITICAL] {{ .GroupLabels.alertname }} - {{ .Status | toUpper }}'
    #     html: |
    #       <html>
    #       <body style="font-family: Arial, sans-serif;">
    #         <h2 style="color: #d32f2f;">Critical Alert Notification</h2>
    #         {{ range .Alerts }}
    #         <div style="border-left: 4px solid #d32f2f; padding-left: 10px; margin: 10px 0;">
    #           <h3>{{ .Annotations.summary }}</h3>
    #           <p><strong>Description:</strong> {{ .Annotations.description }}</p>
    #           <p><strong>Severity:</strong> {{ .Labels.severity }}</p>
    #           <p><strong>Service:</strong> {{ .Labels.service }}</p>
    #           <p><strong>Instance:</strong> {{ .Labels.instance }}</p>
    #           <p><strong>Started:</strong> {{ .StartsAt.Format "2006-01-02 15:04:05 MST" }}</p>
    #           {{ if .EndsAt }}
    #           <p><strong>Resolved:</strong> {{ .EndsAt.Format "2006-01-02 15:04:05 MST" }}</p>
    #           {{ end }}
    #         </div>
    #         {{ end }}
    #       </body>
    #       </html>
    #     send_resolved: true

  # ============================================================================
  # WARNING ALERTS - Slack/Discord only (less spam)
  # ============================================================================
  - name: "warning-receiver"

    # === SLACK CONFIGURATION ===
    # slack_configs:
    #   - api_url: 'https://hooks.slack.com/services/T00000000/B00000000/XXXXXXXXXXXXXXXXXXXX'
    #     channel: '#warnings'
    #     username: 'AlertManager'
    #     icon_emoji: ':warning:'
    #     title: 'Warning: {{ .GroupLabels.alertname }}'
    #     text: '{{ range .Alerts }}{{ .Annotations.summary }}\n{{ end }}'
    #     send_resolved: true
    #     color: 'warning'

    # === DISCORD CONFIGURATION ===
    # webhook_configs:
    #   - url: 'https://discord.com/api/webhooks/YOUR_WEBHOOK_ID/YOUR_WEBHOOK_TOKEN/slack'
    #     send_resolved: true

  # ============================================================================
  # SECURITY ALERTS - High priority, all channels
  # ============================================================================
  - name: "security-receiver"

    # === SLACK CONFIGURATION ===
    # slack_configs:
    #   - api_url: 'https://hooks.slack.com/services/T00000000/B00000000/XXXXXXXXXXXXXXXXXXXX'
    #     channel: '#security-alerts'
    #     username: 'Security Alert'
    #     icon_emoji: ':shield:'
    #     title: 'ðŸ”’ SECURITY ALERT: {{ .GroupLabels.alertname }}'
    #     text: '{{ range .Alerts }}*Alert:* {{ .Annotations.summary }}\n*Details:* {{ .Annotations.description }}\n*Category:* {{ .Labels.category }}\n{{ end }}'
    #     send_resolved: true
    #     color: 'danger'

    # === EMAIL VIA AWS SES ===
    # email_configs:
    #   - to: 'security@yourdomain.com,${SES_TO_EMAIL}'
    #     from: '${SES_FROM_EMAIL}'
    #     headers:
    #       Subject: 'ðŸ”’ SECURITY ALERT: {{ .GroupLabels.alertname }}'
    #       X-Priority: '1'  # High priority
    #     send_resolved: true

  # ============================================================================
  # INFRASTRUCTURE ALERTS
  # ============================================================================
  - name: "infrastructure-receiver"

    # === SLACK CONFIGURATION ===
    # slack_configs:
    #   - api_url: 'https://hooks.slack.com/services/T00000000/B00000000/XXXXXXXXXXXXXXXXXXXX'
    #     channel: '#infrastructure'
    #     username: 'Infrastructure Monitor'
    #     icon_emoji: ':server:'
    #     title: 'Infrastructure Alert: {{ .GroupLabels.alertname }}'
    #     text: '{{ range .Alerts }}{{ .Annotations.summary }}\n{{ end }}'
    #     send_resolved: true

  # ============================================================================
  # DATABASE ALERTS
  # ============================================================================
  - name: "database-receiver"

    # === SLACK CONFIGURATION ===
    # slack_configs:
    #   - api_url: 'https://hooks.slack.com/services/T00000000/B00000000/XXXXXXXXXXXXXXXXXXXX'
    #     channel: '#database-alerts'
    #     username: 'Database Monitor'
    #     icon_emoji: ':database:'
    #     title: 'Database Alert: {{ .GroupLabels.alertname }}'
    #     text: '{{ range .Alerts }}{{ .Annotations.summary }}\n{{ end }}'
    #     send_resolved: true

    # === EMAIL VIA AWS SES ===
    # email_configs:
    #   - to: 'dba@yourdomain.com'
    #     from: '${SES_FROM_EMAIL}'
    #     headers:
    #       Subject: 'Database Alert: {{ .GroupLabels.alertname }}'
    #     send_resolved: true
# ============================================================================
# CONFIGURATION NOTES:
# ============================================================================
#
# 1. SLACK SETUP:
#    - Go to https://api.slack.com/messaging/webhooks
#    - Create an incoming webhook for your workspace
#    - Copy the webhook URL and replace the api_url above
#    - Uncomment the slack_configs sections you want to use
#
# 2. DISCORD SETUP:
#    - Go to Server Settings > Integrations > Webhooks
#    - Create a new webhook
#    - Copy the webhook URL and add '/slack' to the end
#    - Uncomment the webhook_configs sections for Discord
#
# 3. AWS SES SETUP:
#    - Verify your domain or email in AWS SES Console
#    - Create SMTP credentials (different from IAM credentials!)
#    - Set environment variables for SMTP auth
#    - Uncomment global SMTP settings and email_configs
#    - Free tier: 62,000 emails/month (from EC2)
#
# 4. TESTING:
#    - Test with: docker exec alertmanager amtool alert add test severity=warning
#    - Check Alertmanager UI: http://your-domain/alertmanager
#
# 5. ENVIRONMENT VARIABLES (add to .env):
#    AWS_SES_SMTP_USERNAME=your_smtp_username
#    AWS_SES_SMTP_PASSWORD=your_smtp_password
#    SES_FROM_EMAIL=noreply@yourdomain.com
#    SES_TO_EMAIL=admin@yourdomain.com
