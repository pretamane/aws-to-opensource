# Caddyfile - Reverse Proxy Configuration
# Replaces AWS ALB with automatic HTTPS

{
    # Global options
    admin off
    auto_https off
    # Enable for production with real domain:
    # email admin@yourdomain.com
}

# Main application
:80 {
    # Compression for better performance
    encode zstd gzip
    # API endpoints (must come BEFORE static files for priority)
    handle /api/* {
        reverse_proxy fastapi-app:8000
    }
    
    handle /docs* {
        reverse_proxy fastapi-app:8000
    }
    
    handle /redoc* {
        reverse_proxy fastapi-app:8000
    }
    
    handle /openapi.json {
        reverse_proxy fastapi-app:8000
    }
    
    handle /health {
        reverse_proxy fastapi-app:8000
    }
    
    handle /contact {
        reverse_proxy fastapi-app:8000
    }
    
    handle /documents/* {
        reverse_proxy fastapi-app:8000
    }
    
    handle /analytics/* {
        reverse_proxy fastapi-app:8000
    }
    
    handle /stats {
        reverse_proxy fastapi-app:8000
    }
    
    handle /metrics {
        reverse_proxy fastapi-app:8000
    }
    
    # Monitoring dashboards
    handle /grafana* {
        reverse_proxy grafana:3000
    }
    
    redir /pgadmin /pgadmin/
    handle /pgadmin* {
        reverse_proxy pgadmin:80
    }
    
    redir /prometheus /prometheus/graph
    redir /prometheus/ /prometheus/graph
    handle /prometheus* {
        reverse_proxy prometheus:9090
    }
    
    redir /meilisearch /meilisearch/
    handle /meilisearch/* {
        uri strip_prefix /meilisearch
        reverse_proxy meilisearch:7700
    }
    
    # Redirect explicit index to canonical root
    redir /index.html /

    # Static website files (Portfolio website)
    handle /assets/* {
        root * /var/www/pretamane
        header Cache-Control "public, max-age=31536000, immutable"
        file_server
    }
    
    handle /pages/* {
        root * /var/www/pretamane
        file_server
    }
    
    handle /favicon.* {
        root * /var/www/pretamane
        file_server
    }
    
    # Catch-all static: serve files or fallback to index.html
    handle {
        root * /var/www/pretamane
        try_files {path} /index.html
        file_server
    }

    # Optional common static files
    handle /robots.txt {
        root * /var/www/pretamane
        file_server
    }

    handle /sitemap.xml {
        root * /var/www/pretamane
        file_server
    }
    
    # Logging
    log {
        output file /var/log/caddy/access.log
        format json
    }
    
    # CORS headers
    header {
        Access-Control-Allow-Origin *
        Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Access-Control-Allow-Headers "Content-Type, Authorization"
    }
}

# For production with custom domain, use this instead:
# {$DOMAIN:localhost} {
#     reverse_proxy fastapi-app:8000
#     
#     # Automatic HTTPS with Let's Encrypt
#     tls {
#         protocols tls1.2 tls1.3
#     }
#     
#     log {
#         output file /var/log/caddy/access.log
#         format json
#     }
# }


